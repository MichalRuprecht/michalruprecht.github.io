name: Publish scheduled pages

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Publish any due scheduled files from _scheduled/
        run: |
          python3 - << 'PY'
          import os, re, shutil
          from datetime import datetime, timezone
          from zoneinfo import ZoneInfo

          SCHEDULED_DIR = "_scheduled"
          TZ = ZoneInfo("America/New_York")  # auto-handles EST/EDT
          now_utc = datetime.now(timezone.utc)

          def parse_front_matter(path: str):
            with open(path, "r", encoding="utf-8") as f:
              text = f.read()
            if not text.startswith("---"):
              return None
            parts = text.split("---", 2)
            if len(parts) < 3:
              return None
            fm_raw = parts[1].strip("\n")
            fm = {}
            for line in fm_raw.splitlines():
              line = line.strip()
              if not line or line.startswith("#") or ":" not in line:
                continue
              k, v = line.split(":", 1)
              fm[k.strip()] = v.strip().strip('"').strip("'")
            return fm

          def normalize_dest(update_page: str | None, src_filename: str) -> str:
            if not update_page or update_page.strip() == "":
              return src_filename  # publish to repo root with same filename
            u = update_page.strip()
            # strip domain-ish prefixes if you paste them
            u = re.sub(r"^https?://[^/]+/", "", u)
            u = re.sub(r"^michalruprecht\.github\.io/", "", u)
            return u.lstrip("/")

          if not os.path.isdir(SCHEDULED_DIR):
            print(f"No {SCHEDULED_DIR}/ folder. Nothing to do.")
            raise SystemExit(0)

          changed = False

          for name in sorted(os.listdir(SCHEDULED_DIR)):
            if not name.lower().endswith((".html", ".md")):
              continue

            src_path = os.path.join(SCHEDULED_DIR, name)
            fm = parse_front_matter(src_path)
            if not fm:
              continue

            if fm.get("schedule", "").lower() not in ("yes", "true", "1"):
              continue

            date_str = fm.get("date", "").strip()
            time_str = fm.get("time_est", "").strip()  # keep your field name

            if not date_str or not time_str:
              print(f"Skipping {src_path}: missing date or time_est")
              continue

            # date: MM-DD-YYYY or MM/DD/YYYY
            date_str = date_str.replace("/", "-")
            try:
              mm, dd, yyyy = date_str.split("-")
              tparts = time_str.split(":")
              hh = int(tparts[0]); mi = int(tparts[1]); ss = int(tparts[2]) if len(tparts) > 2 else 0
              target_local = datetime(int(yyyy), int(mm), int(dd), hh, mi, ss, tzinfo=TZ)
            except Exception as e:
              print(f"Skipping {src_path}: can't parse date/time ({e})")
              continue

            target_utc = target_local.astimezone(timezone.utc)

            if now_utc < target_utc:
              print(f"Not due yet: {src_path} (NY {target_local.isoformat()} / UTC {target_utc.isoformat()})")
              continue

            dest_rel = normalize_dest(fm.get("update_page"), name)
            os.makedirs(os.path.dirname(dest_rel) or ".", exist_ok=True)

            shutil.copyfile(src_path, dest_rel)
            print(f"Published {src_path} -> {dest_rel}")
            changed = True

            if fm.get("delete_schedule", "").lower() in ("yes", "true", "1"):
              os.remove(src_path)
              print(f"Deleted scheduled source: {src_path}")
              changed = True

          if not changed:
            print("No scheduled files published.")
            raise SystemExit(0)
          PY

      - name: Commit and push if changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Publish scheduled page(s)" || exit 0
          git push origin HEAD
