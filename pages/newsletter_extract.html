<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Newsletter Content Collector</title>
  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; line-height:1.6; background:#f4f4f4; color:#333; margin:0; padding:20px; }
    .container { max-width:800px; margin:0 auto; background:#fff; padding:25px 30px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    h1 { color:#d62021; text-align:center; margin-bottom:10px; }
    p { text-align:left; color:#555; }
    p#instructions { text-align:center; margin-bottom:25px; }
    #story-url { width:100%; padding:12px; border:1px solid #ccc; border-radius:5px; font-size:16px; box-sizing:border-box; }
    #extract-btn { display:block; width:100%; padding:12px; background:#3d79d8; color:#fff; border:none; border-radius:5px; font-size:16px; font-weight:bold; cursor:pointer; margin-top:15px; }
    #extract-btn:disabled { background:#999; cursor:not-allowed; }
    #results { margin-top:30px; border-top:2px solid #eee; padding-top:20px; text-align:center; }
    .result-item { margin-bottom:20px; display:flex; text-align:left; align-items:stretch; gap:10px; }
    .result-item label { font-weight:bold; color:#444; flex-basis:150px; flex-shrink:0; padding-top:8px; }
    .result-item .content-wrapper { flex-grow:1; display:flex; align-items:center; }
    .result-item textarea { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9; font-family:inherit; font-size:15px; box-sizing:border-box; resize:none; overflow:hidden; }
    .result-item .copy-btn { padding:8px 15px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold; white-space:nowrap; }
    .result-item .copy-btn.copied { background:#6c757d; }
    .error-message { color:#d62021; font-weight:bold; }
    .loader { border:5px solid #f3f3f3; border-top:5px solid #3d79d8; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:20px auto; }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
    .small { font-size:12px; color:#777; margin-top:10px; text-align:left; white-space:pre-wrap; }
  </style>
</head>

<body>
<div class="container">
  <h1>Newsletter Content Collector</h1>
  <p id="instructions">Paste the link to the story below.</p>

  <input id="story-url" placeholder="https://www.npr.org/..." type="url"/>
  <button id="extract-btn">Collect Content! UPDATE</button>

  <div id="results"></div>

  <p>Questions? +1 (707) 412-8684
    <center>
      <br>Dig up the gold for your newsletter
      <br>❤️ Michal Ruprecht from the Science Desk
    </center>
  </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ✅ PUT YOUR *REAL* CLOUDFLARE WORKER URL HERE (no trailing slash)
  // Example: "https://npr-proxy-abc123.workers.dev"
  const PROXY_BASE = "https://YOUR-WORKER-NAME.workers.dev";

  const extractBtn = document.getElementById('extract-btn');
  const urlInput = document.getElementById('story-url');
  const resultsDiv = document.getElementById('results');

  const decodeHtml = (htmlStr) => {
    const txt = document.createElement("textarea");
    txt.innerHTML = htmlStr;
    return txt.value;
  };

  const autoResizeTextarea = (textarea) => {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  };

  const fetchWithTimeout = async (url, timeoutMs = 20000) => {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), timeoutMs);
    try {
      return await fetch(url, { signal: controller.signal });
    } finally {
      clearTimeout(t);
    }
  };

  const doExtract = async () => {
    const nprUrl = urlInput.value.trim();

    if (!nprUrl.startsWith('https://www.npr.org')) {
      resultsDiv.innerHTML = '<p class="error-message">Please enter a valid URL starting with "https://www.npr.org"</p>';
      return;
    }

    // Hard stop if you forgot to set the Worker URL
    if (!PROXY_BASE.startsWith("https://") || PROXY_BASE.includes("YOUR-WORKER-NAME")) {
      resultsDiv.innerHTML = '<p class="error-message">This page is not configured.</p><div class="small">Edit newsletter_extract.html and set PROXY_BASE to your real Cloudflare Worker URL.</div>';
      return;
    }

    extractBtn.disabled = true;
    extractBtn.dataset.orig = extractBtn.textContent;
    extractBtn.textContent = 'Fetching...';
    resultsDiv.innerHTML = '<div class="loader"></div><p>Getting story from NPR...</p>';

    const proxyUrl = `${PROXY_BASE}/?url=${encodeURIComponent(nprUrl)}`;

    try {
      const response = await fetchWithTimeout(proxyUrl, 20000);

      if (!response.ok) {
        const body = await response.text().catch(() => "");
        throw new Error(`Proxy/upstream failed.\nURL: ${proxyUrl}\nStatus: ${response.status}\nBody: ${body.slice(0, 300)}`);
      }

      const sourceCode = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(sourceCode, 'text/html');

      const headline =
        doc.querySelector('meta[property="og:title"]')?.getAttribute('content')?.trim() ||
        doc.querySelector('h1')?.textContent?.trim() ||
        'Not Found';

      const storyLink =
        doc.querySelector('link[rel="canonical"]')?.getAttribute('href') ||
        nprUrl;

      const teaser =
        doc.querySelector('meta[name="description"]')?.getAttribute('content') ||
        doc.querySelector('meta[property="og:description"]')?.getAttribute('content') ||
        '';

      let photo = doc.querySelector('meta[property="og:image"]')?.getAttribute('content') || '';

      let authorsArray = [];
      const authorEls = doc.querySelectorAll('p.byline__name.byline__name--block a[rel="author"], .byline__name.byline__name--block a[rel="author"]');
      if (authorEls && authorEls.length > 0) {
        authorEls.forEach(el => {
          const name = el.textContent.trim();
          if (name) authorsArray.push(name);
        });
      } else {
        const metaAuthor = doc.querySelector('meta[name="cXenseParse:author"]')?.getAttribute('content');
        if (metaAuthor) authorsArray = metaAuthor.split('|').map(a => a.trim()).filter(Boolean);
      }

      let photoCredit = 'Not Found in source. Please copy manually.';
      const storytextEl = doc.getElementById('storytext') || doc.querySelector('.storytext, article');
      if (storytextEl) {
        const creditEl = storytextEl.querySelector('.credit[aria-label="Image credit"], b.credit[aria-label="Image credit"], span.credit[aria-label="Image credit"]');
        if (creditEl?.textContent?.trim()) photoCredit = creditEl.textContent.trim();
      }

      let teaserWithoutAuthor = teaser ? teaser.trim() : "Not Found";
      if (teaserWithoutAuthor !== "Not Found" && !teaserWithoutAuthor.endsWith(".")) teaserWithoutAuthor += ".";

      let teaserWithAuthor = teaserWithoutAuthor;
      if (teaser && authorsArray.length > 0) {
        const authorStr = (authorsArray.length === 1)
          ? `${authorsArray[0]} reports for NPR`
          : (authorsArray.length === 2)
            ? `${authorsArray[0]} and ${authorsArray[1]} report for NPR`
            : `${authorsArray.slice(0,-1).join(", ")} and ${authorsArray[authorsArray.length-1]} report for NPR`;
        teaserWithAuthor = `${teaser.trim()} ${authorStr}`;
        if (!teaserWithAuthor.endsWith(".")) teaserWithAuthor += ".";
      }

      const extractedData = [
        { label: 'Headline', id: 'headline', value: headline },
        { label: 'Link to story', id: 'link', value: storyLink },
        { label: 'Photo', id: 'photo', value: photo },
        { label: 'Photo credit', id: 'credit', value: photoCredit },
        { label: 'Teaser', id: 'teaser_no_author', value: teaserWithoutAuthor },
        { label: 'Teaser with author', id: 'teaser', value: teaserWithAuthor }
      ];

      resultsDiv.innerHTML = '';
      extractedData.forEach(item => {
        const cleanValue = item.value ? decodeHtml(item.value) : 'Not Found';
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.innerHTML = `
          <label for="${item.id}-output">${item.label}:</label>
          <div class="content-wrapper">
            <textarea id="${item.id}-output" readonly>${cleanValue}</textarea>
          </div>
          <button class="copy-btn" data-target="${item.id}-output">Copy</button>
        `;
        resultsDiv.appendChild(resultItem);
        autoResizeTextarea(resultItem.querySelector('textarea'));
      });

      const note = document.createElement('div');
      note.className = 'small';
      note.textContent = `OK.\nFetched via: ${proxyUrl}`;
      resultsDiv.appendChild(note);

    } catch (error) {
      // This is where "TypeError: Failed to fetch" lands
      resultsDiv.innerHTML = `
        <p class="error-message">Failed to fetch the story.</p>
        <div class="small">
${String(error && (error.stack || error.message) ? (error.stack || error.message) : error)}
Tried URL: ${proxyUrl}
        </div>
      `;
      console.error(error);
    } finally {
      extractBtn.disabled = false;
      extractBtn.textContent = extractBtn.dataset.orig || 'Collect Content!';
    }
  };

  extractBtn.addEventListener('click', (e) => { e.preventDefault(); doExtract(); });

  resultsDiv.addEventListener('click', (e) => {
    if (e.target.classList.contains('copy-btn')) {
      const button = e.target;
      const targetId = button.dataset.target;
      const textareaToCopy = document.getElementById(targetId);
      navigator.clipboard.writeText(textareaToCopy.value).then(() => {
        button.textContent = 'Copied!';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 1500);
      });
    }
  });
});
</script>
</body>
</html>
