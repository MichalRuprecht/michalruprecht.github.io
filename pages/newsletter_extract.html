<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Newsletter Content Collector</title>
<style>
  body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; line-height:1.6; background:#f4f4f4; color:#333; margin:0; padding:20px; }
  .container { max-width:800px; margin:0 auto; background:#fff; padding:25px 30px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
  h1 { color:#d62021; text-align:center; margin-bottom:10px; }
  p { text-align:left; color:#555; }
  p#instructions { text-align:center; color:#555; margin-bottom:25px; }
  #story-url { width:100%; padding:12px; border:1px solid #ccc; border-radius:5px; font-size:16px; box-sizing:border-box; }
  #extract-btn { display:block; width:100%; padding:12px; background:#3d79d8; color:#fff; border:none; border-radius:5px; font-size:16px; font-weight:bold; cursor:pointer; margin-top:15px; transition:background-color .3s; }
  #extract-btn:hover:not(:disabled){ background:#2a5aab; }
  #extract-btn:disabled { background:#999; cursor:not-allowed; }
  #results { margin-top:30px; border-top:2px solid #eee; padding-top:20px; text-align:center; }
  .result-item { margin-bottom:20px; display:flex; text-align:left; align-items:stretch; gap:10px; }
  .result-item label { font-weight:bold; color:#444; flex-basis:150px; flex-shrink:0; padding-top:8px; }
  .result-item .content-wrapper { flex-grow:1; display:flex; align-items:center; }
  .result-item textarea { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9; font-family:inherit; font-size:15px; box-sizing:border-box; resize:none; overflow:hidden; }
  .result-item .copy-btn { padding:8px 15px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer; transition:background-color .3s; font-weight:bold; white-space:nowrap; }
  .result-item .copy-btn:hover { background:#218838; }
  .result-item .copy-btn.copied { background:#6c757d; }
  .error-message { color:#d62021; font-weight:bold; }
  .loader { border:5px solid #f3f3f3; border-top:5px solid #3d79d8; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:20px auto; }
  @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
</style>
</head>
<body>
<div class="container">
  <h1>Newsletter Content Collector</h1>
  <p id="instructions">Paste the link to the story below.</p>
  <input id="story-url" placeholder="https://www.npr.org/..." type="url"/>
  <button id="extract-btn">Collect Content!</button>
  <div id="results"></div>

  <p>Questions? +1 (707) 412-8684
    <center><br>Dig up the gold for your newsletter
    <br>❤️ Michal Ruprecht from the Science Desk</center>
  </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const extractBtn = document.getElementById('extract-btn');
  const urlInput = document.getElementById('story-url');
  const resultsDiv = document.getElementById('results');

  // ✅ Your Apps Script web app URL
  const APPS_SCRIPT_PROXY = "https://script.google.com/macros/s/AKfycbwFprxcVoAAFo49E86LILzGoSmB2FCZgx7m8ApekEaAgq6pZ6LxHBY3kqTO2Tuw0Fki1Q/exec";

  const decodeHtml = (htmlStr) => {
    const txt = document.createElement("textarea");
    txt.innerHTML = htmlStr;
    return txt.value;
  };

  const autoResizeTextarea = (textarea) => {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  };

  const fetchWithTimeout = async (url, timeoutMs = 20000) => {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), timeoutMs);
    try {
      return await fetch(url, { signal: controller.signal, cache: "no-store" });
    } finally {
      clearTimeout(t);
    }
  };

  const doExtract = async () => {
    const nprUrl = urlInput.value.trim();
    if (!nprUrl.startsWith('https://www.npr.org')) {
      resultsDiv.innerHTML = '<p class="error-message">Please enter a valid URL starting with "https://www.npr.org"</p>';
      return;
    }

    extractBtn.disabled = true;
    extractBtn.dataset.orig = extractBtn.textContent;
    extractBtn.textContent = 'Fetching...';
    resultsDiv.innerHTML = '<div class="loader"></div><p>Getting story from NPR...</p>';

    try {
      const proxyUrl = `${APPS_SCRIPT_PROXY}?url=${encodeURIComponent(nprUrl)}`;
      const res = await fetchWithTimeout(proxyUrl, 20000);
      const text = await res.text();

      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error("Proxy did not return JSON. (Redeploy Apps Script code.)");
      }

      if (data.error) {
        throw new Error(String(data.error) + (data.upstreamStatus ? ` (upstream ${data.upstreamStatus})` : ""));
      }

      const extractedData = [
        { label: 'Headline', id: 'headline', value: decodeHtml(data.headline || 'Not Found') },
        { label: 'Link to story', id: 'link', value: data.link || nprUrl },
        { label: 'Photo', id: 'photo', value: data.photo || '' },
        { label: 'Photo credit', id: 'credit', value: decodeHtml(data.photo_credit || 'Not Found in source. Please copy manually.') },
        { label: 'Teaser', id: 'teaser_no_author', value: decodeHtml(data.teaser || 'Not Found') },
        { label: 'Teaser with author', id: 'teaser', value: decodeHtml(data.teaser_with_author || 'Not Found') }
      ];

      resultsDiv.innerHTML = '';
      extractedData.forEach(item => {
        const cleanValue = item.value ?? 'Not Found';
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.innerHTML = `
          <label for="${item.id}-output">${item.label}:</label>
          <div class="content-wrapper">
            <textarea id="${item.id}-output" readonly>${cleanValue}</textarea>
          </div>
          <button class="copy-btn" data-target="${item.id}-output">Copy</button>
        `;
        resultsDiv.appendChild(resultItem);
        autoResizeTextarea(resultItem.querySelector('textarea'));
      });

    } catch (error) {
      console.error(error);
      resultsDiv.innerHTML = `<p class="error-message">Failed to fetch the story.<br><small>${error.message || String(error)}</small></p>`;
    } finally {
      extractBtn.disabled = false;
      extractBtn.textContent = extractBtn.dataset.orig || 'Collect Content!';
    }
  };

  extractBtn.addEventListener('click', (e) => { e.preventDefault(); doExtract(); });
  urlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); doExtract(); } });

  resultsDiv.addEventListener('click', (e) => {
    if (e.target.classList.contains('copy-btn')) {
      const button = e.target;
      const targetId = button.dataset.target;
      const textareaToCopy = document.getElementById(targetId);
      if (textareaToCopy && navigator.clipboard) {
        navigator.clipboard.writeText(textareaToCopy.value).then(() => {
          button.textContent = 'Copied!';
          button.classList.add('copied');
          setTimeout(() => {
            button.textContent = 'Copy';
            button.classList.remove('copied');
          }, 2000);
        }).catch(() => alert('Failed to copy text.'));
      }
    }
  });
});
</script>
</body>
</html>
