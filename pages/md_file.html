<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clip MD Maker</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#555;
      --line:#ddd;
      --field:#bbb;
      --danger:#d93025;
      --danger-bg:#fff5f5;
      --pill:#f1f1f1;
      --pill-border:#ddd;
      --btn:#111;
      --btnText:#fff;
      --btnSecondaryBg:#fff;
      --btnSecondaryText:#111;
      --radius:14px;
    }

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:24px;
      line-height:1.35;
      max-width:980px;
      color:var(--text);
      background:var(--bg);
      font-size:17px;
    }

    h1{font-size:22px;margin:0 0 14px}

    .row{display:flex;gap:14px;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}

    .field{flex:1;min-width:280px;margin:10px 0}
    label{display:block;font-size:12px;font-weight:700;margin:0 0 6px;color:#111}

    input[type="text"], input[type="url"], input[type="date"], textarea, select{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border:1px solid var(--field);
      border-radius:var(--radius);
      font-size:16px;
      background:#fff;
    }

    textarea{min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .checks{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin:6px 0 0}
    .checks label{display:flex;gap:8px;align-items:center;font-weight:600;font-size:14px;margin:0}

    .muted{color:var(--muted);font-size:14px;margin-top:6px}
    .pill{display:inline-block;background:var(--pill);border:1px solid var(--pill-border);border-radius:999px;padding:3px 10px;font-size:12px}

    .hr{height:1px;background:var(--line);margin:18px 0}

    /* Rich editors */
    .editor{
      width:100%;
      box-sizing:border-box;
      padding:12px;
      border:1px solid var(--field);
      border-radius:var(--radius);
      min-height:220px;
      background:#fff;
      font-size:16px;
      line-height:1.5;
      overflow:auto
    }
    .editor.small{min-height:56px}
    .editor:focus{outline:2px solid #111;outline-offset:2px}
    .editor p{margin:0 0 10px}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .toolbtn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #111;
      background:#fff;
      color:#111;
      font-weight:700;
      cursor:pointer;
      font-size:14px
    }
    .toolbtn.primary{background:#111;color:#fff}
    .toolbtn:active{transform:translateY(1px)}

    /* Required-field validation */
    .field.invalid input,
    .field.invalid textarea,
    .field.invalid .editor{
      border-color: var(--danger) !important;
      background: var(--danger-bg);
    }

    .form-error{
      margin-top: 10px;
      padding: 12px 12px;
      border: 1px solid var(--danger);
      background: var(--danger-bg);
      border-radius: 12px;
      font-size: 15px;
      color: #b31412;
      display: none;
      width:100%;
      box-sizing:border-box;
    }

    /* Main action button */
    button#btnGenerate{
      padding:12px 16px;
      border-radius:14px;
      border:1px solid #111;
      background:#111;
      color:#fff;
      font-weight:800;
      cursor:pointer;
      font-size:16px;
    }
    button#btnGenerate:disabled{opacity:.55;cursor:not-allowed}

    /* Make the date input not full-width so the icon is reachable */
    #pubDate{max-width: 220px; padding-right: 44px;}
    /* Nudge the native calendar icon inward (best-effort across browsers) */
    #pubDate::-webkit-calendar-picker-indicator{
      margin-right: 10px;
    }

    /* Photo story bits */
    .photo-story-wrap{display:none;margin-top:8px}
    .photo-story-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    @media (max-width:900px){.photo-story-grid{grid-template-columns:1fr}}
    .photo-card{border:1px solid #ddd;border-radius:14px;padding:12px;background:#fafafa}
    .photo-card h3{margin:0 0 10px;font-size:14px}
    .photo-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    /* “After download” screen */
    .after-wrap{
      display:none;
      margin-top:18px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      background:#fff;
    }
    .after-title{font-size:18px;font-weight:900;margin:0 0 10px}
    .after-sub{color:var(--muted);font-size:15px;margin:0 0 14px}

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid #111;
      text-decoration:none;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{background:#111;color:#fff}
    .btn.secondary{background:#fff;color:#111}
    .btn:active{transform:translateY(1px)}

    .fileline{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .filename{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      background:var(--pill);
      border:1px solid var(--pill-border);
      padding:6px 10px;
      border-radius:999px;
      font-size:14px;
    }

    .copybtn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #111;
      background:#fff;
      color:#111;
      font-weight:900;
      cursor:pointer;
      font-size:14px;
    }
    .copybtn:active{transform:translateY(1px)}

  </style>
</head>

<body>
  <h1>Clip MD Maker <span class="pill">michalruprecht.github.io</span></h1>

  <!-- MAIN FORM -->
  <div id="app">
    <div class="grid2">
      <div class="field" id="field-title">
        <label>Headline</label>
        <input id="title" type="text" />
      </div>

      <div class="field" id="field-publisher">
        <label>Publisher</label>
        <input id="publisher" type="text" />
      </div>

      <div class="field" id="field-publisherUrl">
        <label>Publisher URL</label>
        <input id="publisherUrl" type="url" placeholder="https://..." />
      </div>

      <div class="field">
        <label>Publication date</label>
        <input id="pubDate" type="date" />
        <div class="muted">Outputs as <span class="pill" id="datePreview"></span></div>
      </div>

      <div class="field">
        <label>Byline</label>
        <input id="byline" type="text" />
      </div>

      <div class="field">
        <label>Clip type</label>
        <div class="checks">
          <label><input id="isPodcast" type="checkbox" /> Podcast</label>
          <label><input id="isVideo" type="checkbox" /> Video</label>
          <label><input id="noPdf" type="checkbox" /> No PDF</label>
          <label><input id="isPhotoStory" type="checkbox" /> Photo story</label>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="field">
      <label>Caption</label>
      <div id="captionEditor" class="editor small" contenteditable="true"></div>
      <div class="toolbar">
        <button class="toolbtn" type="button" data-cmd="bold" data-target="captionEditor">Bold</button>
        <button class="toolbtn" type="button" data-cmd="italic" data-target="captionEditor">Italic</button>
        <button class="toolbtn" type="button" data-cmd="createLink" data-target="captionEditor">Link</button>
        <button class="toolbtn" type="button" data-cmd="removeFormat" data-target="captionEditor">Clear</button>
      </div>
    </div>

    <div class="grid2">
      <div class="field">
        <label>Photo credit</label>
        <input id="photoCredit" type="text" />
      </div>
      <div class="field">
        <label>Embed HTML</label>
        <textarea id="embedHtml" placeholder='<iframe ...></iframe>'></textarea>
      </div>
    </div>

    <div class="photo-story-wrap" id="photoStoryWrap">
      <div class="field">
        <label>Photo story builder</label>
        <div id="photoStoryCards"></div>
        <div class="photo-actions">
          <button class="toolbtn primary" type="button" id="addPhotoBtn">Add next photo</button>
          <button class="toolbtn" type="button" id="clearPhotosBtn">Clear photos</button>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="field">
      <label>Story text</label>
      <div id="storyEditor" class="editor" contenteditable="true"></div>
      <div class="toolbar">
        <button class="toolbtn" type="button" data-cmd="bold" data-target="storyEditor">Bold</button>
        <button class="toolbtn" type="button" data-cmd="italic" data-target="storyEditor">Italic</button>
        <button class="toolbtn" type="button" data-cmd="createLink" data-target="storyEditor">Link</button>
        <button class="toolbtn" type="button" data-cmd="removeFormat" data-target="storyEditor">Clear</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row" style="align-items:center;justify-content:space-between">
      <div id="status" class="muted"></div>
      <button id="btnGenerate" type="button">Download MD file</button>
    </div>

    <div id="formError" class="form-error"></div>
  </div>

  <!-- AFTER DOWNLOAD VIEW (ONLY THIS SHOULD SHOW) -->
  <div id="afterDownload" class="after-wrap">
    <div class="after-title">Next steps</div>
    <div class="after-sub">Upload the files to GitHub using these buttons. Filenames are ready to copy.</div>

    <div class="fileline">
      <a class="btn primary" id="btnUploadMd" target="_blank" rel="noopener"
         href="https://github.com/MichalRuprecht/michalruprecht.github.io/upload/master/pages/clips">
        Upload MD
      </a>
      <span class="filename" id="mdFilename">—</span>
      <button class="copybtn" type="button" id="copyMd">Copy</button>
    </div>

    <div class="fileline">
      <a class="btn primary" id="btnUploadPhoto" target="_blank" rel="noopener"
         href="https://github.com/MichalRuprecht/michalruprecht.github.io/upload/master/pages/clips/assets/photo">
        Upload photo
      </a>
      <span class="filename" id="jpgFilename">—</span>
      <button class="copybtn" type="button" id="copyJpg">Copy</button>
    </div>

    <div class="fileline" id="pdfLine">
      <a class="btn primary" id="btnUploadPdf" target="_blank" rel="noopener"
         href="https://github.com/MichalRuprecht/michalruprecht.github.io/upload/master/pages/clips/assets/pdf">
        Upload PDF
      </a>
      <span class="filename" id="pdfFilename">—</span>
      <button class="copybtn" type="button" id="copyPdf">Copy</button>
    </div>

    <div class="hr"></div>
    <div class="row" style="justify-content:flex-start">
      <button class="toolbtn" type="button" id="makeAnother">Make another clip</button>
    </div>
  </div>

  <script>
    // ====== Small helpers ======
    function $(id){ return document.getElementById(id); }

    function setStatus(msg){
      $("status").textContent = msg || "";
    }

    // Month abbreviations matching your site style
    const MONTHS = ["Jan.","Feb.","Mar.","Apr.","May","June","July","Aug.","Sept.","Oct.","Nov.","Dec."];

    function formatDateDisplayFromISO(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-").map(x=>parseInt(x,10));
      if(!y||!m||!d) return "";
      return `${MONTHS[m-1]} ${d}, ${y}`;
    }

    function todayISO(){
      const dt = new Date();
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const d = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }

    function safeYamlString(v){
      const s = (v ?? "").toString().replace(/\r?\n/g, " ").trim();
      return `"${s.replace(/\\/g, "\\\\").replace(/"/g, '\\"')}"`;
    }

    function normalizeEmbed(raw){
      let s = (raw ?? "").toString().replace(/\r/g, "").trim();
      if(!s) return "";
      const lines = s.split("\n");
      let min = null;
      for(const ln of lines){
        if(!ln.trim()) continue;
        const m = ln.match(/^(\s*)/)[1].length;
        min = (min===null) ? m : Math.min(min, m);
      }
      const out = lines.map(ln => ln.slice(min || 0));
      return out.map(ln => "  " + ln).join("\n");
    }

    function sanitizeHTML(html){
      const tmp = document.createElement("div");
      tmp.innerHTML = html || "";

      const ALLOWED = new Set(["P","BR","STRONG","B","EM","I","A","UL","OL","LI"]);

      function walk(node){
        const children = Array.from(node.childNodes);
        for(const child of children){
          if(child.nodeType === Node.ELEMENT_NODE){
            const tag = child.tagName.toUpperCase();
            if(!ALLOWED.has(tag)){
              const frag = document.createDocumentFragment();
              while(child.firstChild) frag.appendChild(child.firstChild);
              child.replaceWith(frag);
              continue;
            }

            const attrs = Array.from(child.attributes || []);
            for(const a of attrs){
              const name = a.name.toLowerCase();
              if(tag === "A"){
                if(name === "href" || name === "target" || name === "rel") continue;
              }
              child.removeAttribute(a.name);
            }
            if(tag === "A"){
              child.setAttribute("target","_blank");
              child.setAttribute("rel","noopener");
            }

            walk(child);
          } else if(child.nodeType === Node.COMMENT_NODE){
            child.remove();
          }
        }
      }
      walk(tmp);

      tmp.querySelectorAll("b").forEach(el=>{
        const s = document.createElement("strong");
        s.innerHTML = el.innerHTML;
        el.replaceWith(s);
      });
      tmp.querySelectorAll("i").forEach(el=>{
        const e = document.createElement("em");
        e.innerHTML = el.innerHTML;
        el.replaceWith(e);
      });

      return tmp.innerHTML.trim();
    }

    function htmlToBody(html){
      if(!html) return "";
      return html
        .replace(/<\/p>\s*<p>/g, "</p>\n\n<p>")
        .replace(/<\/ul>\s*<p>/g, "</ul>\n\n<p>")
        .replace(/<\/ol>\s*<p>/g, "</ol>\n\n<p>")
        .trim();
    }

    // ====== Rich toolbar ======
    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-cmd]");
      if(!btn) return;
      const cmd = btn.dataset.cmd;
      const targetId = btn.dataset.target;
      const target = document.getElementById(targetId);
      if(!target) return;

      target.focus();

      if(cmd === "createLink"){
        const url = prompt("Paste URL:");
        if(url) document.execCommand("createLink", false, url);
        return;
      }
      document.execCommand(cmd, false, null);
    });

    // ====== Photo story UI ======
    let photoCount = 0;

    function suffixForIndex(i){
      if(i === 0) return "";
      const code = "b".charCodeAt(0) + (i-1);
      return String.fromCharCode(code);
    }

    function renderPhotoCards(){
      const wrap = $("photoStoryCards");
      wrap.innerHTML = "";
      for(let i=0; i<photoCount; i++){
        const suf = suffixForIndex(i);
        const card = document.createElement("div");
        card.className = "photo-card";
        card.innerHTML = `
          <h3>Photo ${i+1} (suffix: <span class="pill">${suf || "(base)"}</span>)</h3>
          <div class="photo-story-grid">
            <div>
              <label>Caption</label>
              <div id="psCap${i}" class="editor small" contenteditable="true"></div>
              <div class="toolbar">
                <button class="toolbtn" type="button" data-cmd="bold" data-target="psCap${i}">Bold</button>
                <button class="toolbtn" type="button" data-cmd="italic" data-target="psCap${i}">Italic</button>
                <button class="toolbtn" type="button" data-cmd="createLink" data-target="psCap${i}">Link</button>
                <button class="toolbtn" type="button" data-cmd="removeFormat" data-target="psCap${i}">Clear</button>
              </div>
            </div>
            <div>
              <label>Credit</label>
              <input id="psCred${i}" type="text" />
            </div>
          </div>
        `;
        wrap.appendChild(card);
      }
    }

    $("isPhotoStory").addEventListener("change", ()=>{
      const on = $("isPhotoStory").checked;
      $("photoStoryWrap").style.display = on ? "block" : "none";
      if(on && photoCount === 0){
        photoCount = 1;
        renderPhotoCards();
      }
    });

    $("addPhotoBtn").addEventListener("click", ()=>{
      photoCount += 1;
      renderPhotoCards();
    });

    $("clearPhotosBtn").addEventListener("click", ()=>{
      photoCount = 0;
      renderPhotoCards();
    });

    // ====== GitHub fetch next number ======
    const GH_OWNER = "michalruprecht";
    const GH_REPO  = "michalruprecht.github.io";
    const CLIPS_PATH = "pages/clips";

    async function fetchNextClipNumber(){
      const api = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${CLIPS_PATH}`;
      const res = await fetch(api, { headers: { "Accept":"application/vnd.github+json" }});
      if(!res.ok) throw new Error(`GitHub API error (${res.status})`);
      const items = await res.json();

      let max = 0;
      for(const it of items){
        if(it.type !== "file") continue;
        const m = (it.name || "").match(/^(\d+)\.md$/);
        if(!m) continue;
        const n = parseInt(m[1], 10);
        if(Number.isFinite(n)) max = Math.max(max, n);
      }
      return max + 1;
    }

    // ====== Required fields validation ======
    const required = [
      { id: "title", label: "Headline" },
      { id: "publisher", label: "Publisher" },
      { id: "publisherUrl", label: "Publisher URL" },
    ];

    function setFieldInvalid(el, isInvalid){
      const field = el.closest(".field");
      if(field) field.classList.toggle("invalid", isInvalid);
    }

    function validateRequired(showError){
      const missing = [];
      for(const f of required){
        const el = $(f.id);
        const val = (el.value || "").trim();
        const invalid = !val || (el.type === "url" && !el.checkValidity());
        setFieldInvalid(el, invalid);
        if(invalid) missing.push(f.label);
      }

      const ok = missing.length === 0;
      $("btnGenerate").disabled = !ok;

      const err = $("formError");
      if(showError && !ok){
        err.textContent = "Please fill out: " + missing.join(", ") + ".";
        err.style.display = "block";
      } else {
        err.textContent = "";
        err.style.display = "none";
      }
      return ok;
    }

    required.forEach(f=>{
      const el = $(f.id);
      el.addEventListener("input", ()=>validateRequired(false));
      el.addEventListener("blur",  ()=>validateRequired(false));
    });

    // ====== Build MD ======
    function buildMD(nextId){
      const title = $("title").value.trim();
      const publisher = $("publisher").value.trim();
      const publisherUrl = $("publisherUrl").value.trim();
      const byline = $("byline").value.trim();

      const iso = $("pubDate").value;
      const dateDisplay = formatDateDisplayFromISO(iso);

      const isPodcast = $("isPodcast").checked;
      const isVideo = $("isVideo").checked;
      const pdfFalse = $("noPdf").checked;
      const isPhotoStory = $("isPhotoStory").checked;

      const capHtml = sanitizeHTML($("captionEditor").innerHTML);
      const photoCredit = $("photoCredit").value.trim();

      const embedNorm = normalizeEmbed($("embedHtml").value);

      const storySan = sanitizeHTML($("storyEditor").innerHTML);
      const storyBody = htmlToBody(storySan);

      const lines = [];
      lines.push("---");
      lines.push(`layout: clip`);
      lines.push(`title: ${safeYamlString(title)}`);
      lines.push(`clip: true`);
      lines.push(`clip_id: ${nextId}`);
      lines.push(`publisher: ${safeYamlString(publisher)}`);
      lines.push(`date_display: ${safeYamlString(dateDisplay)}`);
      lines.push(`byline: ${safeYamlString(byline)}`);
      lines.push(`publisher_url: ${safeYamlString(publisherUrl)}`);

      if(capHtml) lines.push(`caption_html: ${safeYamlString(capHtml)}`);
      if(photoCredit) lines.push(`photo_credit: ${safeYamlString(photoCredit)}`);

      if(pdfFalse) lines.push(`pdf: false`);
      if(isPodcast) lines.push(`podcast: true`);
      if(isVideo) lines.push(`video: true`);
      if(isPhotoStory) lines.push(`photo_story: true`);

      if(isPhotoStory){
        lines.push(`photo_story_total: ${photoCount}`);
        lines.push(`photo_story_items:`);
        for(let i=0;i<photoCount;i++){
          const suf = suffixForIndex(i);
          const cap = sanitizeHTML(document.getElementById(`psCap${i}`)?.innerHTML || "");
          const cred = (document.getElementById(`psCred${i}`)?.value || "").trim();
          lines.push(`  - suffix: ${safeYamlString(suf)}`);
          lines.push(`    caption_html: ${safeYamlString(cap)}`);
          lines.push(`    photo_credit: ${safeYamlString(cred)}`);
        }
      }

      if(embedNorm){
        lines.push(`embed_html: |`);
        lines.push(embedNorm);
      }

      lines.push("---");
      lines.push("");
      lines.push(storyBody || "");
      lines.push("");

      return lines.join("\n");
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ====== Defaults ======
    function syncDatePreview(){
      $("datePreview").textContent = formatDateDisplayFromISO($("pubDate").value) || "—";
    }
    $("pubDate").value = todayISO();
    syncDatePreview();
    $("pubDate").addEventListener("change", syncDatePreview);

    $("byline").value = "Michal Ruprecht";

    validateRequired(false);

    // ====== Copy helpers ======
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
    }

    // ====== Main action ======
    $("btnGenerate").addEventListener("click", async ()=>{
      if(!validateRequired(true)) return;

      try{
        $("btnGenerate").disabled = true;
        setStatus("Finding next clip number…");

        const nextId = await fetchNextClipNumber();
        setStatus(`Generating ${nextId}.md…`);

        const md = buildMD(nextId);
        downloadText(`${nextId}.md`, md);

        // Build filenames with your rules:
        // - For 01–09 assets use leading zero
        // - 10–99 no leading zero
        // - 100+ normal
        const assetId = (nextId < 10) ? String(nextId).padStart(2,"0") : String(nextId);

        const mdName  = `${nextId}.md`;
        const jpgName = `${assetId}.jpg`;
        const pdfName = `${assetId}.pdf`;

        $("mdFilename").textContent = mdName;
        $("jpgFilename").textContent = jpgName;

        // PDF: only show if NOT checked "No PDF"
        const hasPdf = !$("noPdf").checked;
        $("pdfLine").style.display = hasPdf ? "flex" : "none";
        $("pdfFilename").textContent = pdfName;

        // wire copy buttons
        $("copyMd").onclick  = ()=>copyText(mdName);
        $("copyJpg").onclick = ()=>copyText(jpgName);
        $("copyPdf").onclick = ()=>copyText(pdfName);

        // switch view: hide everything else, show only buttons
        $("app").style.display = "none";
        $("afterDownload").style.display = "block";
      }catch(err){
        console.error(err);
        setStatus(`Error: ${err.message}`);
      }finally{
        $("btnGenerate").disabled = false;
      }
    });

    $("makeAnother").addEventListener("click", ()=>{
      $("afterDownload").style.display = "none";
      $("app").style.display = "block";
      setStatus("");
      validateRequired(false);
      window.scrollTo({top:0, behavior:"smooth"});
    });
  </script>
</body>
</html>
