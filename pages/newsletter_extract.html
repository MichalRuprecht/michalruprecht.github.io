<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Newsletter Content Collector</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    line-height: 1.6;
    background-color: #f4f4f4;
    color: #333;
    margin: 0;
    padding: 20px;
  }
  .container {
    max-width: 800px;
    margin: 0 auto;
    background-color: #fff;
    padding: 25px 30px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }
  h1 { color: #d62021; text-align: center; margin-bottom: 10px; }
  p { text-align: left; color: #555; }
  p#instructions { text-align: center; color: #555; margin-bottom: 25px; }
  #story-url {
    width: 100%;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
    box-sizing: border-box;
  }
  #extract-btn {
    display: block;
    width: 100%;
    padding: 12px;
    background-color: #3d79d8;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 15px;
    transition: background-color 0.3s;
  }
  #extract-btn:hover:not(:disabled) { background-color: #2a5aab; }
  #extract-btn:disabled { background-color: #999; cursor: not-allowed; }

  #results {
    margin-top: 30px;
    border-top: 2px solid #eee;
    padding-top: 20px;
    text-align: center;
  }
  .result-item {
    margin-bottom: 20px;
    display: flex;
    text-align: left;
    align-items: stretch;
    gap: 10px;
  }
  .result-item label {
    font-weight: bold;
    color: #444;
    flex-basis: 150px;
    flex-shrink: 0;
    padding-top: 8px;
  }
  .result-item .content-wrapper { flex-grow: 1; display: flex; align-items: center; }
  .result-item textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #f9f9f9;
    font-family: inherit;
    font-size: 15px;
    box-sizing: border-box;
    resize: none;
    overflow: hidden;
  }
  .result-item .copy-btn {
    padding: 8px 15px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-weight: bold;
    white-space: nowrap;
  }
  .result-item .copy-btn:hover { background-color: #218838; }
  .result-item .copy-btn.copied { background-color: #6c757d; }

  .error-message { color: #d62021; font-weight: bold; }

  .loader {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3d79d8;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .debug {
    margin-top: 12px;
    font-size: 12px;
    color: #777;
    text-align: left;
    white-space: pre-wrap;
    border-top: 1px dashed #eee;
    padding-top: 10px;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Newsletter Content Collector</h1>
  <p id="instructions">Paste the link to the story below.</p>
  <input id="story-url" placeholder="https://www.npr.org/..." type="url"/>
  <button id="extract-btn">Collect Content! UPDATE</button>
  <div id="results"></div>

  <p>Questions? +1 (707) 412-8684
    <center><br>Dig up the gold for your newsletter
    <br>❤️ Michal Ruprecht from the Science Desk</center>
  </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const extractBtn = document.getElementById('extract-btn');
  const urlInput = document.getElementById('story-url');
  const resultsDiv = document.getElementById('results');

  // ✅ Your Apps Script proxy
  const APPS_SCRIPT_PROXY = "https://script.google.com/macros/s/AKfycbwFprxcVoAAFo49E86LILzGoSmB2FCZgx7m8ApekEaAgq6pZ6LxHBY3kqTO2Tuw0Fki1Q/exec";

  const decodeHtml = (htmlStr) => {
    const txt = document.createElement("textarea");
    txt.innerHTML = htmlStr;
    return txt.value;
  };

  const autoResizeTextarea = (textarea) => {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  };

  // ✅ IMPORTANT: Apps Script cold starts can be slow. Give it time.
  const fetchWithTimeout = async (url, timeoutMs = 60000) => {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), timeoutMs);
    try {
      return await fetch(url, { signal: controller.signal, cache: "no-store" });
    } finally {
      clearTimeout(t);
    }
  };

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  // ✅ One retry (helps a ton with Apps Script cold starts)
  const fetchTextWithRetry = async (url) => {
    try {
      const res = await fetchWithTimeout(url, 60000);
      const text = await res.text();
      return { res, text, attempt: 1 };
    } catch (e) {
      // if aborted or transient, retry once after a short pause
      await sleep(800);
      const res2 = await fetchWithTimeout(url, 60000);
      const text2 = await res2.text();
      return { res: res2, text: text2, attempt: 2 };
    }
  };

  const doExtract = async () => {
    const nprUrl = urlInput.value.trim();

    if (!nprUrl.startsWith('https://www.npr.org')) {
      resultsDiv.innerHTML = '<p class="error-message">Please enter a valid URL starting with "https://www.npr.org"</p>';
      return;
    }

    extractBtn.disabled = true;
    extractBtn.dataset.orig = extractBtn.textContent;
    extractBtn.textContent = 'Fetching...';
    resultsDiv.innerHTML = '<div class="loader"></div><p>Getting story from NPR... (can take ~30–60s on first load)</p>';

    const proxyUrl = `${APPS_SCRIPT_PROXY}?url=${encodeURIComponent(nprUrl)}`;

    try {
      const { res: response, text: sourceCode, attempt } = await fetchTextWithRetry(proxyUrl);

      if (!response.ok) {
        throw new Error(`Proxy returned HTTP ${response.status}\nAttempt: ${attempt}\nTried: ${proxyUrl}\nBody: ${sourceCode.slice(0, 300)}`);
      }

      if (!sourceCode || sourceCode.length < 500) {
        throw new Error(`Proxy returned empty/short HTML\nAttempt: ${attempt}\nTried: ${proxyUrl}\nBody: ${String(sourceCode).slice(0, 300)}`);
      }

      const parser = new DOMParser();
      const doc = parser.parseFromString(sourceCode, 'text/html');

      const headline =
        doc.querySelector('meta[property="og:title"]')?.getAttribute('content')?.trim() ||
        doc.querySelector('h1')?.textContent?.trim() ||
        'Not Found';

      const storyLink = doc.querySelector('link[rel="canonical"]')?.getAttribute('href') || nprUrl;

      // Photo: first picture inside storytext, fallback to og:image
      let photo = '';
      try {
        const storytextTarget = doc.querySelector('#storytext.storytext.storylocation.linkLocation') || doc.getElementById('storytext');
        if (storytextTarget) {
          const firstPicture = storytextTarget.querySelector('picture');
          if (firstPicture) {
            let candidate =
              firstPicture.querySelector('source')?.getAttribute('srcset') ||
              firstPicture.querySelector('img')?.getAttribute('src') ||
              '';
            if (candidate) {
              candidate = candidate.split(',')[0].trim().split(/\s+/)[0];
              candidate = candidate.replace(/\/resize\/\d+/, '/resize/600');
              candidate = candidate.replace(/\/quality\/\d+/, '/quality/85');
              candidate = candidate.replace(/\/format\/\w+/, '/format/png');
              photo = candidate;
            }
          }
        }
      } catch (e) { photo = ''; }

      if (!photo) {
        photo = doc.querySelector('meta[property="og:image"]')?.getAttribute('content') || '';
        if (photo) {
          photo = photo.replace(/\/resize\/\d+/, '/resize/600');
          photo = photo.replace(/\/quality\/\d+/, '/quality/85');
          photo = photo.replace(/\/format\/\w+/, '/format/png');
        }
      }

      const teaser = doc.querySelector('meta[name="description"]')?.getAttribute('content') || '';

      // Authors
      let authorsArray = [];
      const authorEls = doc.querySelectorAll('p.byline__name.byline__name--block a[rel="author"], .byline__name.byline__name--block a[rel="author"]');
      if (authorEls && authorEls.length > 0) {
        authorEls.forEach(el => {
          const name = el.textContent.trim();
          if (name) authorsArray.push(name);
        });
      } else {
        const metaAuthor = doc.querySelector('meta[name="cXenseParse:author"]')?.getAttribute('content');
        if (metaAuthor) authorsArray = metaAuthor.split('|').map(a => a.trim()).filter(a => a);
      }

      // Photo credit
      let photoCredit = 'Not Found in source. Please copy manually.';
      const storytextEl = doc.getElementById('storytext') || doc.querySelector('.storytext.storylocation, .storytext');
      if (storytextEl) {
        const creditInStory = storytextEl.querySelector('.credit[aria-label="Image credit"], b.credit[aria-label="Image credit"], span.credit[aria-label="Image credit"]');
        if (creditInStory && creditInStory.textContent && creditInStory.textContent.trim()) {
          photoCredit = creditInStory.textContent.trim();
        }
      }

      // Teaser without author
      let teaserWithoutAuthor = "Not Found";
      if (teaser) {
        teaserWithoutAuthor = teaser;
        if (!teaserWithoutAuthor.trim().endsWith(".")) teaserWithoutAuthor += ".";
      }

      // Teaser with author
      let teaserWithAuthor = "Not Found";
      if (!Array.isArray(authorsArray)) authorsArray = [];

      if (teaser) {
        if (authorsArray.length > 0) {
          let authorStr = "";
          if (authorsArray.length === 1) authorStr = authorsArray[0] + " reports for NPR";
          else if (authorsArray.length === 2) authorStr = authorsArray[0] + " and " + authorsArray[1] + " report for NPR";
          else authorStr = authorsArray.slice(0, -1).join(", ") + " and " + authorsArray[authorsArray.length - 1] + " report for NPR";

          teaserWithAuthor = teaser + " " + authorStr;
          if (!teaserWithAuthor.trim().endsWith(".")) teaserWithAuthor += ".";
        } else {
          teaserWithAuthor = teaser;
          if (!teaserWithAuthor.trim().endsWith(".")) teaserWithAuthor += ".";
        }
      } else if (authorsArray.length > 0) {
        if (authorsArray.length === 1) teaserWithAuthor = authorsArray[0] + " reports for NPR.";
        else if (authorsArray.length === 2) teaserWithAuthor = authorsArray[0] + " and " + authorsArray[1] + " report for NPR.";
        else teaserWithAuthor = authorsArray.slice(0, -1).join(", ") + " and " + authorsArray[authorsArray.length - 1] + " report for NPR.";
      }

      const extractedData = [
        { label: 'Headline', id: 'headline', value: headline },
        { label: 'Link to story', id: 'link', value: storyLink },
        { label: 'Photo', id: 'photo', value: photo },
        { label: 'Photo credit', id: 'credit', value: photoCredit },
        { label: 'Teaser', id: 'teaser_no_author', value: teaserWithoutAuthor },
        { label: 'Teaser with author', id: 'teaser', value: teaserWithAuthor }
      ];

      resultsDiv.innerHTML = '';
      extractedData.forEach(item => {
        const cleanValue = item.value ? decodeHtml(item.value) : 'Not Found';
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.innerHTML = `
          <label for="${item.id}-output">${item.label}:</label>
          <div class="content-wrapper">
            <textarea id="${item.id}-output" readonly>${cleanValue}</textarea>
          </div>
          <button class="copy-btn" data-target="${item.id}-output">Copy</button>
        `;
        resultsDiv.appendChild(resultItem);
        autoResizeTextarea(resultItem.querySelector('textarea'));
      });

      const dbg = document.createElement('div');
      dbg.className = 'debug';
      dbg.textContent = `Fetched via: ${proxyUrl}\n(Attempt ${attempt}, timeout 60s)`;
      resultsDiv.appendChild(dbg);

    } catch (error) {
      console.error(error);
      resultsDiv.innerHTML = `
        <p class="error-message">Failed to fetch the story.<br><small>${error.message || String(error)}</small></p>
        <div class="debug">Tried: ${proxyUrl}\nIf this still times out, the proxy is slow or blocked — then we move parsing into Apps Script and return small JSON (fast).</div>
      `;
    } finally {
      extractBtn.disabled = false;
      extractBtn.textContent = extractBtn.dataset.orig || 'Collect Content!';
    }
  };

  extractBtn.addEventListener('click', (e) => { e.preventDefault(); doExtract(); });
  urlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); doExtract(); } });

  resultsDiv.addEventListener('click', (e) => {
    if (e.target.classList.contains('copy-btn')) {
      const button = e.target;
      const targetId = button.dataset.target;
      const textareaToCopy = document.getElementById(targetId);
      if (textareaToCopy && navigator.clipboard) {
        navigator.clipboard.writeText(textareaToCopy.value).then(() => {
          button.textContent = 'Copied!';
          button.classList.add('copied');
          setTimeout(() => {
            button.textContent = 'Copy';
            button.classList.remove('copied');
          }, 2000);
        });
      }
    }
  });
});
</script>
</body>
</html>
